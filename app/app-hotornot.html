<script>
var API = require('./items/API');

Slim.tag('app-hotornot', class extends Slim {

    get loadedTemplate() {
        return `
<h2>Slim: Hot or not!?</h2>
<span bind>[[voteCount]] Votes so far!</span>
<hr/>
<add-item on-new="handleNewItem"></add-item>
<hr/>
<hot-item slim-repeat="items" slim-repeat-as="item" on-vote="handleVote"></hot-item>
`
    }

    get template() {
        return `<div>Loading...</div>`
    }

    handleVote(item) {
        API.vote(item.id);
    }

    handleNewItem(details) {
        API.addItem(details.name, details.img);
    }

    onBeforeCreated() {
        this.items = [];
        this.voteCount = 0;
        API.observer.on('value', (context) => {
            let raw = context.val();
            this.items = [];
            this.voteCount = 0;
            this.items = Object.keys(raw).map( key => {
                if (raw[key].votes) {
                    this.voteCount += raw[key].votes;
                }
                return {
                    id: key,
                    data: raw[key]
                }
            });
            this.items = this.items.sort( (a,b) => {
                if (a.data.votes < b.data.votes) return 1;
                return -1;
            });
            this.render(this.loadedTemplate);
        })
    }

});
</script>
<style>

</style>